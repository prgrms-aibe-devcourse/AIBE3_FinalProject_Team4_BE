name: be-build

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: prgrms-aibe-devcourse/aibe3-finalproject-team4-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout source
        uses: actions/checkout@v4

      # 2) Login to GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_OWNER }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 3) Set up JDK
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 4) Grant execute permission to Gradle
      - name: Grant execute permission to Gradle wrapper
        run: chmod +x ./gradlew

      # 5) Build JAR (선행 빌드)
      - name: Build Spring Boot Jar
        run: ./gradlew clean bootJar --no-daemon

      # 6) Build Docker image
      - name: Build Docker image
        working-directory: ./be
        run: |
          docker build \
            -t $REGISTRY/$IMAGE_NAME:latest \
            .

      # 7) Push Docker image
      - name: Push Docker image
        working-directory: ./be
        run: |
          docker push $REGISTRY/$IMAGE_NAME:latest

      # 8) Store tag for deploy workflow
      - name: Save image version
        run: echo "IMAGE_TAG=latest" >> $GITHUB_ENV
