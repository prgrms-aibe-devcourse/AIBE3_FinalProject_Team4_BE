name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

env:
  MAX_TOKENS: '2000'
  MAX_FILES: '40'
  MAX_LINES: '1800'
  EXCLUDE_GLOBS: |
    **/node_modules/**
    **/build/**
    **/out/**
    **/target/**
    **/bin/**
    **/*.jar
    **/*.class
    **/*.log
    **/*.png
    **/*.jpg
    **/*.svg
    **/*.gif
    **/*.zip
    **/*.map
    **/*.pdf
    **/*Test.java

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Check trigger
        id: gate
        run: |
          set -euo pipefail
          EVENT="${{ github.event_name }}"
          if [[ "$EVENT" == "issue_comment" ]]; then
            BODY="${{ github.event.comment.body }}"
            if [[ ! "$BODY" =~ ^/ai-review ]]; then
              echo "not_needed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          if [[ "$EVENT" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "not_needed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Exit if not needed
        if: steps.gate.outputs.not_needed == 'true'
        run: echo "â­ï¸ Skip AI review"

      - name: Checkout repo
        if: steps.gate.outputs.not_needed != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SHAs
        id: shas
        if: steps.gate.outputs.not_needed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            PR="${{ github.event.pull_request.number }}"
          else
            PR="${{ github.event.issue.number }}"
            BASE=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .base.sha)
            HEAD=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .head.sha)
          fi
          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "pr=$PR" >> "$GITHUB_OUTPUT"

      - name: Decide Model
        id: model
        run: |
          set -euo pipefail
          MODEL="gpt-4o-mini"
          PR=${{ steps.shas.outputs.pr }}
          LABELS=$(gh pr view $PR --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -qi "high-priority"; then
            MODEL="gpt-4o"
          fi
          LINES=$(git diff --unified=0 "${{ steps.shas.outputs.base }}" "${{ steps.shas.outputs.head }}" | grep -E '^(\+|\-)' | wc -l | tr -d ' ')
          if (( LINES > 400 )); then MODEL="gpt-4o"; fi
          echo "model=$MODEL" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Filter files
        id: files
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"
          mapfile -t DIFF < <(git diff --name-only "$BASE" "$HEAD")
          EXCLUDES=()
          while IFS= read -r pat; do [[ -n "$pat" ]] && EXCLUDES+=("$pat"); done <<< "$EXCLUDE_GLOBS"
          FILTERED=()
          for f in "${DIFF[@]}"; do
            SKIP=0
            for g in "${EXCLUDES[@]}"; do [[ $f == $g || $f == */$g ]] && SKIP=1 && break; done
            (( SKIP == 0 )) && FILTERED+=("$f")
          done
          [[ ${#FILTERED[@]} -gt ${MAX_FILES} ]] && FILTERED=("${FILTERED[@]:0:${MAX_FILES}}")
          printf "%s\n" "${FILTERED[@]}" > files.txt
          echo "list=$(jq -R -s -c 'split(\"\\n\")[:-1]' files.txt)" >> "$GITHUB_OUTPUT"

      - name: Create patch JSON
        id: diff
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"
          LINES=$(git diff --unified=0 "$BASE" "$HEAD" | grep -E '^(\+|\-)' | wc -l | tr -d ' ')
          if (( LINES > ${MAX_LINES} )); then
            jq -n --argjson files '${{ steps.files.outputs.list }}' '{oversize:true, files:$files}' > diff.json
            echo "oversize=true" >> "$GITHUB_OUTPUT"
          else
            git diff "$BASE" "$HEAD" > diff.patch
            BYTES=$(wc -c < diff.patch | tr -d ' ')
            (( BYTES > 200000 )) && head -c 200000 diff.patch > diff.patch.trim && mv diff.patch.trim diff.patch
            jq -n --rawfile patch diff.patch --arg base "$BASE" --arg head "$HEAD" \
              '{oversize:false, base:$base, head:$head, patch:$patch}' > diff.json
            echo "oversize=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ§  Validate OpenAI API Key
        env:
          OPENAI_API_KEY: ${{ secrets.WORKFLOW_OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          echo "ğŸ” Checking OpenAI API key validity..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.openai.com/v1/models \
            -H "Authorization: Bearer $OPENAI_API_KEY")
          if [ "$STATUS" -eq 200 ]; then
            echo "âœ… OpenAI API key is valid."
          elif [ "$STATUS" -eq 401 ]; then
            echo "âŒ Invalid API key or expired. Check your WORKFLOW_OPENAI_API_KEY secret."
            exit 1
          elif [ "$STATUS" -eq 429 ]; then
            echo "âš ï¸ API quota exceeded. Check your billing or usage limits."
            exit 1
          else
            echo "âš ï¸ Unexpected response (HTTP $STATUS)."
            exit 1
          fi

      - name: Build review prompt (Hybrid Expert)
        run: |
          PR=${{ steps.shas.outputs.pr }}
          cat << 'EOF' > system.txt
          ë‹¹ì‹ ì€ **ì‹œë‹ˆì–´ ë°±ì—”ë“œ ì•„í‚¤í…íŠ¸ ê²¸ Java ì½”ë“œ ë¦¬ë·° ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.
          ë¦¬ë·° ëŒ€ìƒì€ Spring Boot ê¸°ë°˜ Java ë°±ì—”ë“œ ì½”ë“œì´ë©°, ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒì€ JPA, Hibernate, Spring Security, REST API, JUnit + Mockitoì…ë‹ˆë‹¤.
          ëª©í‘œëŠ” ë‹¨ìˆœ ì§€ì ì´ ì•„ë‹Œ **ì •í™•í•œ ì›ì¸ ë¶„ì„ â†’ ì‹¤ì§ˆì  ê°œì„  ë°©ì•ˆ â†’ ì½”ë“œ ì˜ˆì‹œ**ë¥¼ ì œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

          ğŸ’¡ ë¦¬ë·° ì›ì¹™:
          - êµ¬ì²´ì ì´ê³  ê·¼ê±° ì¤‘ì‹¬
          - ë„ë©”ì¸ ì˜ë„ì™€ íŠ¸ëœì­ì…˜ êµ¬ì¡° ê³ ë ¤
          - ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„± (No feedback generated ê¸ˆì§€)

          ğŸ§© ë¦¬ë·° ë²”ìœ„:
          - Controller / Service / Repository / Entity / Exception / Test / Security / ì„±ëŠ¥

          âš™ï¸ ì¶œë ¥ í˜•ì‹:
          ### ğŸ§  ìš”ì•½
          - í•µì‹¬ ë¦¬ìŠ¤í¬ 1~3ê°œ
          ### âš ï¸ ì„¸ë¶€ ì½”ë“œ ë¦¬ë·°
          - [íŒŒì¼:ì¤„] ë¬¸ì œ â†’ ì›ì¸ â†’ ê°œì„  ë°©ì•ˆ (+ ì˜ˆì‹œ)
          ### ğŸ§ª í…ŒìŠ¤íŠ¸ ì œì•ˆ
          - ê²€ì¦ìš© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
          ### ğŸ”§ ìë™ ìˆ˜ì • ê°€ëŠ¥ ì˜ˆì‹œ
          - ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ì½”ë“œ ìŠ¤ë‹ˆí«
          EOF

          {
            echo "<PR_META>"
            gh api repos/${{ github.repository }}/pulls/$PR --jq '{title:.title, author:.user.login, body:.body}'
            echo "</PR_META>"
            echo "<DIFF_PATCH>"
            git diff ${{ steps.shas.outputs.base }} ${{ steps.shas.outputs.head }}
            echo "</DIFF_PATCH>"
          } > user.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Call OpenAI
        id: llm
        env:
          OPENAI_API_KEY: ${{ secrets.WORKFLOW_OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          MODEL=gpt-4o

          # ğŸ§  ì•ˆì „í•œ JSON ë¬¸ìì—´ ì¸ì½”ë”©
          PAYLOAD=$(jq -n \
            --arg model "$MODEL" \
            --arg sys "$(jq -Rs . < system.txt)" \
            --arg usr "$(jq -Rs . < user.txt)" \
            --argjson mt 4000 \
            '{model:$model, messages:[{role:"system",content:$sys},{role:"user",content:$usr}], max_tokens:$mt, temperature:0.2}'
          )

          echo "ğŸ“¤ Sending request to OpenAI..."
          RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD" || true)

          echo "$RESP" > llm_response.json
          echo "âœ… Response size: $(wc -c < llm_response.json) bytes"

          # âš ï¸ ì—ëŸ¬ ë©”ì‹œì§€ ê°ì§€
          ERROR_MSG=$(jq -r '.error.message // empty' < llm_response.json)
          if [[ -n "$ERROR_MSG" ]]; then
            echo "âŒ OpenAI API returned error:"
            echo "   â†’ $ERROR_MSG"
            echo ""
            echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
            echo " - 'insufficient_quota': OpenAI ê²°ì œ í¬ë ˆë”§ ì¶©ì „ í•„ìš”"
            echo " - 'invalid_api_key': í‚¤ê°€ ì˜ëª»ëê±°ë‚˜ ë§Œë£Œë¨"
            echo " - ê¸°íƒ€ ì˜¤ë¥˜: prompt í¬ê¸°, JSON í¬ë§· ë˜ëŠ” ì¼ì‹œì  ì„œë²„ ì´ìŠˆ"
            exit 1
          fi

          # âš™ï¸ ì‘ë‹µ ë‚´ìš© ì¶”ì¶œ
          CONTENT=$(jq -r '.choices[0].message.content // empty' < llm_response.json)
          if [[ -z "$CONTENT" ]]; then
            echo "âš ï¸ Model returned empty response (no content in .choices)"
            echo "ğŸ” Debug info: $(jq -r '. | keys_unsorted' < llm_response.json)"
            exit 1
          fi

          echo "$CONTENT" > llm_content.txt
          echo "âœ… AI review content extracted successfully."
      

      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ steps.shas.outputs.pr }}
          {
            echo "### ğŸ¤– AI Code Review (Spring Boot Expert)"
            echo "<details><summary>ë¦¬ë·° ê²°ê³¼ ë³´ê¸°</summary>"
            echo ""
            cat llm_content.txt
            echo ""
            echo "</details>"
          } > comment.txt
          gh api repos/${{ github.repository }}/issues/$PR/comments -f body="$(cat comment.txt)"
