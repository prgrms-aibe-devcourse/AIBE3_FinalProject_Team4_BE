name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}             # ‚úÖ Î™®Îì† gh Î™ÖÎ†π Ïù∏Ï¶ùÏö©
      OPENAI_API_KEY: ${{ secrets.WORKFLOW_OPENAI_API_KEY }}
      MAX_TOKENS: '2000'
      MAX_FILES: '40'
      MAX_LINES: '1800'
      EXCLUDE_GLOBS: |
        **/node_modules/**
        **/build/**
        **/out/**
        **/target/**
        **/bin/**
        **/*.jar
        **/*.class
        **/*.log
        **/*.png
        **/*.jpg
        **/*.svg
        **/*.gif
        **/*.zip
        **/*.map
        **/*.pdf
        **/*Test.java

    steps:
      - name: üß≠ Check trigger
        id: gate
        continue-on-error: true
        run: |
          set -euo pipefail
          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "issue_comment" ]]; then
            BODY="${{ github.event.comment.body }}"
            if [[ ! "$BODY" =~ ^/ai-review ]]; then
              echo "not_needed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if [[ "$EVENT" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "not_needed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: ‚è≠Ô∏è Exit if not needed
        if: steps.gate.outputs.not_needed == 'true'
        run: echo "AI review not required for this event."

      - name: üì¶ Checkout repo
        if: steps.gate.outputs.not_needed != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Ensure GitHub CLI
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          gh --version || (sudo apt-get update && sudo apt-get install -y gh)

      - name: üßÆ Setup SHAs
        id: shas
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            PR="${{ github.event.pull_request.number }}"
          else
            PR="${{ github.event.issue.number }}"
            BASE=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .base.sha)
            HEAD=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .head.sha)
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "pr=$PR" >> "$GITHUB_OUTPUT"

      - name: üß† Decide Model
        id: model
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          set -euo pipefail
          MODEL="gpt-4o-mini"
          PR=${{ steps.shas.outputs.pr }}

          LABELS=$(gh pr view $PR --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -qi "high-priority"; then
            MODEL="gpt-4o"
          fi

          DIFF_LINES=$(git diff --unified=0 "${{ steps.shas.outputs.base }}" "${{ steps.shas.outputs.head }}" | grep -E '^(\+|\-)' | wc -l | tr -d ' ')
          DIFF_FILES=$(git diff --name-only "${{ steps.shas.outputs.base }}" "${{ steps.shas.outputs.head }}" | wc -l | tr -d ' ')
          if (( DIFF_LINES > 400 || DIFF_FILES > 20 )); then
            MODEL="gpt-4o"
          fi

          echo "model=$MODEL" >> "$GITHUB_OUTPUT"

      - name: üßπ Filter files
        id: files
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"
          mapfile -t DIFF < <(git diff --name-only "$BASE" "$HEAD")

          EXCLUDES=()
          while IFS= read -r pat; do [[ -n "$pat" ]] && EXCLUDES+=("$pat"); done <<< "$EXCLUDE_GLOBS"

          FILTERED=()
          shopt -s extglob
          for f in "${DIFF[@]}"; do
            SKIP=0
            for g in "${EXCLUDES[@]}"; do
              [[ $f == $g || $f == @($g) ]] && SKIP=1 && break
            done
            (( SKIP == 0 )) && FILTERED+=("$f")
          done
          shopt -u extglob

          [[ ${#FILTERED[@]} -gt ${MAX_FILES} ]] && FILTERED=("${FILTERED[@]:0:${MAX_FILES}}")

          printf "%s\n" "${FILTERED[@]}" > files.txt
          echo "list=$(jq -R -s -c 'split(\"\\n\")[:-1]' files.txt)" >> "$GITHUB_OUTPUT"

      - name: üß± Create patch JSON
        id: diff
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"
          LINES=$(git diff --unified=0 "$BASE" "$HEAD" | grep -E '^(\+|\-)' | wc -l | tr -d ' ')

          if (( LINES > ${MAX_LINES} )); then
            jq -n --argjson files '${{ steps.files.outputs.list }}' '{oversize:true, files:$files}' > diff.json
            echo "oversize=true" >> "$GITHUB_OUTPUT"
          else
            git diff "$BASE" "$HEAD" > diff.patch
            BYTES=$(wc -c < diff.patch | tr -d ' ')
            (( BYTES > 180000 )) && head -c 180000 diff.patch > diff.patch.trim && mv diff.patch.trim diff.patch

            jq -n --rawfile patch diff.patch --arg base "$BASE" --arg head "$HEAD" \
              '{oversize:false, base:$base, head:$head, patch:$patch}' > diff.json
            echo "oversize=false" >> "$GITHUB_OUTPUT"
          fi

      - name: üèóÔ∏è Build prompt
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          PR=${{ steps.shas.outputs.pr }}
          {
            echo "ÎãπÏã†ÏùÄ **ÏãúÎãàÏñ¥ Î∞±ÏóîÎìú ÏïÑÌÇ§ÌÖçÌä∏ Í≤∏ Java ÏΩîÎìú Î¶¨Î∑∞ Ï†ÑÎ¨∏Í∞Ä**ÏûÖÎãàÎã§."
            echo "Î¶¨Î∑∞ ÎåÄÏÉÅ: Spring Boot Î∞±ÏóîÎìú (JPA, Hibernate, Spring Security, REST API, JUnit/Mockito)"
            echo "Î¶¨Î∑∞ Î™©Ìëú: Î¨∏Ï†ú Î∂ÑÏÑù ‚Üí Í∞úÏÑ†Ïïà ‚Üí ÏΩîÎìú ÏòàÏãú"
            echo ""
            echo "üí° Î¶¨Î∑∞ ÏõêÏπô:"
            echo "- Í∑ºÍ±∞ Í∏∞Î∞ò ÏàòÏ†ï Ï†úÏïà"
            echo "- ÎèÑÎ©îÏù∏/ÎπÑÏ¶àÎãàÏä§ Îß•ÎùΩ Í≥†Î†§"
            echo "- ÌïúÍµ≠Ïñ¥ ÏûëÏÑ±"
            echo ""
            echo "üß© Î¶¨Î∑∞ Î≤îÏúÑ:"
            echo "- Entity/Service/Controller ÏÑ§Í≥Ñ, JPA Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ, Lazy Î°úÎî©, N+1, Ìä∏ÎûúÏû≠ÏÖò, ÏòàÏô∏ Ï≤òÎ¶¨, ÌÖåÏä§Ìä∏, ÏΩîÎìú ÌíàÏßà"
          } > system.txt

          : > user.txt
          echo "<PR_META>" >> user.txt
          gh api repos/${{ github.repository }}/pulls/$PR --jq '{title:.title, author:.user.login, labels: [.labels[].name], body:.body}' >> user.txt
          echo "</PR_META>" >> user.txt

          echo "<DIFF_JSON>" >> user.txt
          jq -c . < diff.json >> user.txt
          echo "</DIFF_JSON>" >> user.txt

          echo "<DIFF_PATCH>" >> user.txt
          git diff ${{ steps.shas.outputs.base }} ${{ steps.shas.outputs.head }} >> user.txt
          echo "</DIFF_PATCH>" >> user.txt

      - name: ü§ñ Call OpenAI
        id: llm
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          set -euo pipefail
          MODEL=${{ steps.model.outputs.model }}

          echo "üîç Using model: $MODEL"
          PAYLOAD=$(jq -n \
            --arg model "$MODEL" \
            --arg sys "$(cat system.txt)" \
            --arg usr "$(cat user.txt)" \
            --argjson mt ${MAX_TOKENS} \
            '{model:$model, messages:[{role:"system",content:$sys},{role:"user",content:$usr}], max_tokens:$mt, temperature:0.2}'
          )

          RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD" || echo '{}'
          )

          if jq -e '.choices[0].message.content' <<<"$RESP" >/dev/null 2>&1; then
            jq -r '.choices[0].message.content' <<<"$RESP" > llm_content.txt
          else
            echo "‚ö†Ô∏è AI ÏùëÎãµ Ïã§Ìå®. ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî." > llm_content.txt
          fi

      - name: üí¨ Comment PR
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          PR=${{ steps.shas.outputs.pr }}
          {
            echo "### ü§ñ AI Code Review"
            echo "<details><summary>üßæ Î¶¨Î∑∞ ÎÇ¥Ïö© Î≥¥Í∏∞</summary>"
            echo ""
            cat llm_content.txt
            echo ""
            echo "</details>"
          } > comment.txt

          gh api repos/${{ github.repository }}/issues/$PR/comments \
            -f body="$(cat comment.txt)"
