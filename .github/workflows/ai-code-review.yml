name: AI Code Review (Free Tier)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

env:
  MAX_TOKENS: '2000'
  MAX_FILES: '10'        # Î¨¥Î£å Í≥ÑÏ†ïÏö©ÏúºÎ°ú Ï†úÌïú
  MAX_LINES: '200'       # Î¨¥Î£å Í≥ÑÏ†ïÏö©ÏúºÎ°ú Ï†úÌïú
  EXCLUDE_GLOBS: |
    **/node_modules/**
    **/build/**
    **/out/**
    **/target/**
    **/bin/**
    **/*.jar
    **/*.class
    **/*.log
    **/*.png
    **/*.jpg
    **/*.svg
    **/*.gif
    **/*.zip
    **/*.map
    **/*.pdf
    **/*Test.java

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Check trigger
        id: gate
        run: |
          set -euo pipefail
          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "issue_comment" ]]; then
            BODY="${{ github.event.comment.body }}"
            if [[ ! "$BODY" =~ ^/ai-review ]]; then
              echo "not_needed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if [[ "$EVENT" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "not_needed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Exit if not needed
        if: steps.gate.outputs.not_needed == 'true'
        run: echo "‚è≠Ô∏è Skip AI review"

      - name: Checkout repo
        if: steps.gate.outputs.not_needed != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SHAs
        id: shas
        if: steps.gate.outputs.not_needed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            PR="${{ github.event.pull_request.number }}"
          else
            PR="${{ github.event.issue.number }}"
            BASE=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .base.sha)
            HEAD=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .head.sha)
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "pr=$PR" >> "$GITHUB_OUTPUT"

      - name: Decide Model (Free Tier)
        id: model
        run: |
          echo "model=gpt-3.5-turbo" >> "$GITHUB_OUTPUT"

      - name: Filter files
        id: files
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"

          mapfile -t DIFF < <(git diff --name-only "$BASE" "$HEAD")

          EXCLUDES=()
          while IFS= read -r pat; do [[ -n "$pat" ]] && EXCLUDES+=("$pat"); done <<< "$EXCLUDE_GLOBS"

          FILTERED=()
          for f in "${DIFF[@]}"; do
            SKIP=0
            for g in "${EXCLUDES[@]}"; do
              [[ $f == $g || $f == */$g ]] && SKIP=1 && break
            done
            (( SKIP == 0 )) && FILTERED+=("$f")
          done

          [[ ${#FILTERED[@]} -gt ${MAX_FILES} ]] && FILTERED=("${FILTERED[@]:0:${MAX_FILES}}")

          printf "%s\n" "${FILTERED[@]}" > files.txt
          echo "list=$(jq -R -s -c 'split(\"\\n\")[:-1]' files.txt)" >> "$GITHUB_OUTPUT"

      - name: Create patch JSON
        id: diff
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"

          LINES=$(git diff --unified=0 "$BASE" "$HEAD" | grep -E '^(\+|\-)' | wc -l | tr -d ' ')

          if (( LINES > ${MAX_LINES} )); then
            jq -n --argjson files '${{ steps.files.outputs.list }}' '{oversize:true, files:$files}' > diff.json
            echo "oversize=true" >> "$GITHUB_OUTPUT"
          else
            git diff "$BASE" "$HEAD" > diff.patch
            BYTES=$(wc -c < diff.patch | tr -d ' ')
            (( BYTES > 200000 )) && head -c 200000 diff.patch > diff.patch.trim && mv diff.patch.trim diff.patch

            jq -n --rawfile patch diff.patch --arg base "$BASE" --arg head "$HEAD" \
              '{oversize:false, base:$base, head:$head, patch:$patch}' > diff.json
            echo "oversize=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build prompt
        run: |
          PR=${{ steps.shas.outputs.pr }}

          {
            echo "ÎãπÏã†ÏùÄ **ÏãúÎãàÏñ¥ Î∞±ÏóîÎìú ÏïÑÌÇ§ÌÖçÌä∏ Í≤∏ Java ÏΩîÎìú Î¶¨Î∑∞ Ï†ÑÎ¨∏Í∞Ä**ÏûÖÎãàÎã§."
            echo "Î¶¨Î∑∞ ÎåÄÏÉÅÏùÄ Spring Boot Í∏∞Î∞òÏùò Java Î∞±ÏóîÎìú ÏΩîÎìúÏù¥Î©∞, Ï£ºÏöî Í∏∞Ïà† Ïä§ÌÉùÏùÄ JPA, Hibernate, Spring Security, REST API, Í∑∏Î¶¨Í≥† ÌÖåÏä§Ìä∏Îäî JUnit + MockitoÏûÖÎãàÎã§."
            echo "Î¶¨Î∑∞Ïùò Î™©ÌëúÎäî Îã®ÏàúÌûà Î¨∏Ï†úÎ•º ÏßÄÏ†ÅÌïòÎäî Í≤ÉÏù¥ ÏïÑÎãàÎùº, Í∞úÎ∞úÏûêÍ∞Ä Ï¶âÏãú Í∞úÏÑ†Ìï† Ïàò ÏûàÎèÑÎ°ù **Ï†ïÌôïÌïú ÏõêÏù∏ Î∂ÑÏÑù ‚Üí Ïã§ÏßàÏ†ÅÏù∏ Í∞úÏÑ† Î∞©Ïïà ‚Üí ÏΩîÎìú ÏòàÏãú**Î•º Ï†úÍ≥µÌïòÎäî Í≤ÉÏûÖÎãàÎã§."
            echo ""
            echo "üí° Î¶¨Î∑∞ Í∏∞Î≥∏ ÏõêÏπô:"
            echo "- Î™®Ìò∏Ìïú Ïπ≠Ï∞¨ ÎåÄÏã†, Í∑ºÍ±∞ Í∏∞Î∞òÏùò ÏàòÏ†ï Ï†úÏïàÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§."
            echo "- ÏΩîÎìúÏùò ÏùòÎèÑÏôÄ ÎèÑÎ©îÏù∏ Îß•ÎùΩÏùÑ Í≥†Î†§Ìï¥ Ïã§Î¨¥Ï†ÅÏù∏ ÌîºÎìúÎ∞±ÏùÑ Ï†úÏãúÌï©ÎãàÎã§."
            echo "- Î¶¨Î∑∞Îäî Î∞òÎìúÏãú **ÌïúÍµ≠Ïñ¥**Î°ú ÏûëÏÑ±ÌïòÎ©∞, 'No feedback generated'ÏôÄ Í∞ôÏùÄ Î¨¥ÏùòÎØ∏Ìïú ÏùëÎãµÏùÄ ÌóàÏö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§."
            echo ""
            echo "üß© Î¶¨Î∑∞ Î≤îÏúÑ (Î≥ÄÍ≤ΩÎêú ÏΩîÎìú Ï†ÑÎ∂Ä Î∂ÑÏÑù):"
            echo "- **ÎèÑÎ©îÏù∏ ÏÑ§Í≥Ñ Î∞è Ïó≠Ìï† Î∂ÑÎ¶¨ (DDD)**: Entity, Service, Controller Í∞Ñ Ï±ÖÏûÑÏù¥ Ï†ÅÏ†àÌïòÍ≤å Î∂ÑÎ¶¨ÎêòÏóàÎäîÍ∞Ä?"
            echo "- **JPA Îß§Ìïë Î∞è ÏÑ±Îä• Ïù¥Ïäà**: Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ, Lazy Î°úÎî©, N+1 ÏøºÎ¶¨, Î∂àÌïÑÏöîÌïú ÏøºÎ¶¨ Î∞úÏÉù Ïó¨Î∂Ä"
            echo "- **Service Í≥ÑÏ∏µ ÏÑ§Í≥Ñ**: ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅÏù¥ Ïûò Î∂ÑÎ¶¨ÎêòÏñ¥ ÏûàÎäîÍ∞Ä? Ìä∏ÎûúÏû≠ÏÖò Ï≤òÎ¶¨Í∞Ä Ï†ÅÏ†àÌïúÍ∞Ä?"
            echo "- **REST API Î™ÖÏÑ∏ Î∞è Ïª®Î≤§ÏÖò Ï§ÄÏàò**: URL ÏÑ§Í≥Ñ, ÏùëÎãµ Ìè¨Îß∑, ÏÉÅÌÉú ÏΩîÎìúÍ∞Ä ÏùºÍ¥ÄÏ†ÅÏù∏Í∞Ä?"
            echo "- **ÏòàÏô∏ Ï≤òÎ¶¨ Î∞è Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨**: Ïª§Ïä§ÌÖÄ ÏòàÏô∏, ÏòàÏô∏ Ìï∏Îì§Îü¨, Request validationÏù¥ Ï†ÅÏ†àÌïúÍ∞Ä?"
            echo "- **ÌÖåÏä§Ìä∏ ÏûëÏÑ±**: Îã®ÏúÑ ÌÖåÏä§Ìä∏ / ÌÜµÌï© ÌÖåÏä§Ìä∏Ïùò Ïª§Î≤ÑÎ¶¨ÏßÄÍ∞Ä Ï∂©Î∂ÑÌïúÍ∞Ä? Mockito ÏÇ¨Ïö©Ïù¥ Ï†ÅÏ†àÌïúÍ∞Ä?"
            echo "- **ÏΩîÎìú ÌíàÏßà**: Î©îÏÑúÎìú Î™ÖÌôïÏÑ±, Ï§ëÎ≥µ Ï†úÍ±∞, ÏùòÏ°¥ÏÑ± Ï£ºÏûÖ Î∞©Ïãù, Î∂àÌïÑÏöîÌïú Î°úÏßÅ Ï†úÍ±∞ Îì±"
            echo ""
            echo "‚öôÔ∏è Î¶¨Î∑∞ Î∞©Î≤ï:"
            echo "1. Î≥ÄÍ≤ΩÎêú ÌååÏùºÏùÑ Ìïú Ï§Ñ Îã®ÏúÑÎ°ú Î∂ÑÏÑùÌïòÏó¨, Îã§Ïùå Ìï≠Î™©Îì§ÏùÑ Î™ÖÌôïÌûà ÏûëÏÑ±ÌïòÏÑ∏Ïöî:"
            echo "   - Î¨∏Ï†ú ÏΩîÎìú Î∞è Ï§Ñ Î≤àÌò∏"
            echo "   - Ïñ¥Îñ§ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌï† Ïàò ÏûàÎäîÏßÄ Î™ÖÌôïÌïú Ïù¥Ïú†"
            echo "   - ÏàòÏ†ï Î∞©Ìñ• + ÏΩîÎìú ÏòàÏãú"
            echo "   - Í¥ÄÎ†®Îêú Java/Spring ÏõêÏπô, ÏÑ±Îä• Í≥†Î†§ÏÇ¨Ìï≠ Îì±ÏùÑ Ìï®Íªò Ï†úÏãú"
            echo "   - **Ï†ÅÏñ¥ÎèÑ 5Í∞ú Ïù¥ÏÉÅÏùò Ï£ºÏöî ÌîºÎìúÎ∞±ÏùÑ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.**"
            echo ""
            echo "2. ÏΩîÎìúÍ∞Ä Ïûò ÏûëÏÑ±Îêú Í≤ΩÏö∞ÏóêÎèÑ Ïù¥Ïú†ÏôÄ Ìï®Íªò Ïñ∏Í∏âÌï©ÎãàÎã§. (Ïòà: Ï†ÅÏ†àÌïú Ï∫°ÏäêÌôî, Ìä∏ÎûúÏû≠ÏÖò Î∂ÑÎ¶¨ Ïö∞Ïàò Îì±)"
            echo ""
            echo "3. ÏïÑÎûò ÌòïÏãùÏúºÎ°ú Î∞òÎìúÏãú Ï∂úÎ†•Ìï©ÎãàÎã§:"
            echo ""
            echo "### üß† ÏöîÏïΩ"
            echo "- Ïù¥ PRÏóêÏÑú ÎààÏóê ÎùÑÎäî Ï£ºÏöî Î¶¨Ïä§ÌÅ¨ 1~3Í∞úÎ•º Í∞ÑÍ≤∞ÌïòÍ≤å Ï†ïÎ¶¨"
            echo ""
            echo "### ‚ö†Ô∏è ÏÑ∏Î∂Ä ÏΩîÎìú Î¶¨Î∑∞"
            echo "- [ÌååÏùºÎ™Ö:Ï§ÑÎ≤àÌò∏] Î¨∏Ï†ú ÏÑ§Î™Ö ‚Üí ÏõêÏù∏ ‚Üí Í∞úÏÑ† Î∞©Ïïà (+ ÏΩîÎìú ÏòàÏãú)"
            echo "- Ïã§Ï†ú ÏàòÏ†ï Í∞ÄÎä•Ìïú ÌòïÌÉúÎ°ú ÏûëÏÑ±Ìï† Í≤É"
            echo "- Í∞ÄÎä•Ìïú Ìïú ÎßéÏùÄ Î¨∏Ï†úÎ•º Ï∞æÏïÑÏÑú ÏûëÏÑ±ÌïòÏÑ∏Ïöî. ÏµúÏÜå 5Í∞ú Ïù¥ÏÉÅÏù¥ Í∂åÏû•Îê©ÎãàÎã§."
            echo ""
            echo "### üß™ ÌÖåÏä§Ìä∏ Ï†úÏïà"
            echo "- Í∞úÏÑ†Îêú ÏΩîÎìúÏóê ÎåÄÌï¥ Ïñ¥Îñ§ ÌÖåÏä§Ìä∏Î•º ÏûëÏÑ±ÌïòÎ©¥ Ï¢ãÏùÑÏßÄ ÏïÑÏù¥ÎîîÏñ¥ Ï†úÏãú"
            echo ""
            echo "### üîß ÏûêÎèô ÏàòÏ†ï Í∞ÄÎä• ÏòàÏãú (ÏÑ†ÌÉù)"
            echo "- Ï¶âÏãú Ï†ÅÏö© Í∞ÄÎä•Ìïú ÏïàÏ†ÑÌïú ÏΩîÎìú Ïä§ÎãàÌé´Ïù¥ ÏûàÎã§Î©¥ Î™ÖÏãú"
            echo ""
            echo "Î¶¨Î∑∞Îäî Ïã§Î¨¥Ï†ÅÏù∏ ÌÜµÏ∞∞Í≥º ÍπäÏù¥ ÏûàÎäî Í∞úÏÑ† Î∞©Ìñ•ÏùÑ Ï§ëÏ†êÏúºÎ°ú ÏûëÏÑ±ÎêòÏñ¥Ïïº ÌïòÎ©∞, Îã®ÏàúÌïú Ïä§ÌÉÄÏùº ÌîºÎìúÎ∞±ÏùÄ ÏßÄÏñëÌï©ÎãàÎã§."
          } > system.txt
          
          : > user.txt
          
          echo "<PR_META>" >> user.txt
          gh api repos/${{ github.repository }}/pulls/$PR --jq '{title:.title, author:.user.login, labels: [.labels[].name], body:.body}' >> user.txt
          echo "</PR_META>" >> user.txt
          
          echo "<REVIEW_SCOPE>" >> user.txt
          echo "- Î≥ÄÌôîÎêú ÌååÏùºÎßå Î¶¨Î∑∞Ìï©ÎãàÎã§ (diff Ï∞∏Í≥†)" >> user.txt
          echo "- Ï†ÑÏ≤¥ Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Ïª®ÌÖçÏä§Ìä∏Îäî ÏöîÏ≤≠ÌïòÏßÄ ÎßàÏÑ∏Ïöî" >> user.txt
          echo "</REVIEW_SCOPE>" >> user.txt
          
          echo "<TECH_STACK_HINTS>" >> user.txt
          echo "- Java 17+, Spring Boot 3.x, JPA, Hibernate, Spring Security, REST API, JUnit/Mockito" >> user.txt
          echo "- Ìä∏ÎûúÏû≠ÏÖò Í¥ÄÎ¶¨, ÎèÑÎ©îÏù∏ ÏÑ§Í≥Ñ, ÏøºÎ¶¨ ÏÑ±Îä• ÏµúÏ†ÅÌôî, ÏóêÎü¨ Ï≤òÎ¶¨ Ï†ÑÎûµ, ÌÖåÏä§Ìä∏ ÌíàÏßà" >> user.txt
          echo "</TECH_STACK_HINTS>" >> user.txt
          
          echo "<OUTPUT_FORMAT>" >> user.txt
          echo "- ÏöîÏïΩ: Ï£ºÏöî Î¶¨Ïä§ÌÅ¨ 1~3Í∞ú" >> user.txt
          echo "- Ïù¥Ïäà Î™©Î°ù: ÌååÏùºÍ≤ΩÎ°ú/ÎùºÏù∏Î≤àÌò∏(Í∞ÄÎä• Ïãú) + Î¨∏Ï†ú + ÏõêÏù∏ + Í∞úÏÑ†Ïïà + ÏΩîÎìú Ïä§ÎãàÌé´" >> user.txt
          echo "- ÌÖåÏä§Ìä∏ Ï†úÏïà: Í∞úÏÑ† ÌõÑ Í≤ÄÏ¶ùÌï† Ïàò ÏûàÎäî ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§" >> user.txt
          echo "- ÏûêÎèô ÏàòÏ†ï Í∞ÄÎä• Ïä§ÎãàÌé´: ÏûàÎã§Î©¥ Ï†úÏãú" >> user.txt
          echo "</OUTPUT_FORMAT>" >> user.txt
          
          echo "<DIFF_JSON>" >> user.txt
          jq -c . < diff.json >> user.txt
          echo "</DIFF_JSON>" >> user.txt
          
          echo "<DIFF_PATCH>" >> user.txt
          git diff ${{ steps.shas.outputs.base }} ${{ steps.shas.outputs.head }} >> user.txt
          echo "</DIFF_PATCH>" >> user.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Call OpenAI
        id: llm
        env:
          OPENAI_API_KEY: ${{ secrets.WORKFLOW_OPENAI_API_KEY }}
          MAX_TOKENS: ${{ env.MAX_TOKENS }}
        run: |
          set -euo pipefail

          MAX_TOKENS_NUMBER=$(echo $MAX_TOKENS | tr -d "'")
          MODEL=${{ steps.model.outputs.model }}

          PAYLOAD=$(jq -n \
            --arg model "$MODEL" \
            --arg sys "$(cat system.txt)" \
            --arg usr "$(cat user.txt)" \
            --argjson mt $MAX_TOKENS_NUMBER \
            '{model:$model, messages:[{role:"system",content:$sys},{role:"user",content:$usr}], max_tokens:$mt, temperature:0.2}')

          RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD"
          )

          echo "$RESP" > llm_response.json

          if jq -e '.error.code == "insufficient_quota"' llm_response.json >/dev/null 2>&1; then
            echo "QUOTA_EXCEEDED=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          jq -r '.choices[0].message.content // "‚ö†Ô∏è Model returned empty response"' < llm_response.json > llm_content.txt

      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ steps.shas.outputs.pr }}

          if [[ "${{ steps.llm.outputs.QUOTA_EXCEEDED }}" == "true" ]]; then
            echo "### ‚ö†Ô∏è AI Code Review skipped" > comment.txt
            echo "OpenAI API quota exceeded. Please check your account plan or usage." >> comment.txt
          else
            echo "### ü§ñ AI Code Review" > comment.txt
            echo "<details><summary>View results</summary>" >> comment.txt
            cat llm_content.txt >> comment.txt
            echo "</details>" >> comment.txt
          fi

          gh api repos/${{ github.repository }}/issues/$PR/comments \
            -f body="$(cat comment.txt)"
