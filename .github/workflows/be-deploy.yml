name: be-deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout â€” í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ ê¸°ë³¸ìœ¼ë¡œ ë‘ 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) SSHë¥¼ ìœ„í•´ í‚¤ ì„¤ì •
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # 3) EC2ì— SSH ì ‘ì†í•´ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} "
            cd /home/ec2-user/app && \
            echo 'ğŸ”„ Pulling latest image...' && \
            docker pull ghcr.io/${{ secrets.GHCR_OWNER }}/aibe3-finalproject-team4-backend:latest && \
            echo 'ğŸš€ Running deploy.sh...' && \
            bash deploy.sh
          "

      # 4) ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
      - name: Deployment completed
        run: echo "ğŸ‰ Backend deployment finished successfully!"
